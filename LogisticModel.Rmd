---
title: "LogisticRegression"
author: "Jonathan Flores"
date: "April 7, 2018"
output: 
  html_document:
    keep_md: yes
---
## Load Raw Data from GitHub

```{r echo=TRUE, results='asis'}

## RCurl library reads saved csvs documents on GitHub.The code below process information from GitHub instead of our local computers

library(RCurl)
library(psych)

attritionraw <- data.frame(read.csv(text = getURL("https://raw.githubusercontent.com/cyberkoolman/msds.6306.case.study.2/master/data/CaseStudy2-data1.csv"),header = TRUE,sep=","))

```


## Changing the entire data set into numeric information in order to run a logistic regression analysis

```{r echo=TRUE, results='asis'}

library(knitr)

must_convert<-sapply(attritionraw,is.factor) # logical vector telling if a variable needs to be displayed as numeric 

M2<-sapply(attritionraw[,must_convert],unclass) # data.frame of all categorical variables now displayed as numeric

attritionclean <-cbind(attritionraw[,!must_convert],M2) # complete data.frame with all variables put together

knitr::kable(head(attritionclean)) 
```

## Converting respective categorical variabes to run the model

```{r echo=TRUE, results='asis'}

attritionclean$Attrition <- as.factor(attritionclean$Attrition)
attritionclean$BusinessTravel <- as.factor(attritionclean$BusinessTravel)
attritionclean$Department <- as.factor(attritionclean$Department)
attritionclean$Education <- as.factor(attritionclean$Education)
attritionclean$EducationField <- as.factor(attritionclean$EducationField)
attritionclean$EnvironmentSatisfaction <- as.factor(attritionclean$EnvironmentSatisfaction)
attritionclean$Gender <- as.factor(attritionclean$Gender)
attritionclean$JobInvolvement <- as.factor(attritionclean$JobInvolvement)
attritionclean$JobLevel <- as.factor(attritionclean$JobLevel)
attritionclean$JobRole <- as.factor(attritionclean$JobRole)
attritionclean$JobSatisfaction <- as.factor(attritionclean$JobSatisfaction)
attritionclean$Department <- as.factor(attritionclean$Department)
attritionclean$MaritalStatus <- as.factor(attritionclean$MaritalStatus)
attritionclean$OverTime <- as.factor(attritionclean$OverTime)
attritionclean$PerformanceRating <- as.factor(attritionclean$PerformanceRating)
attritionclean$RelationshipSatisfaction <- as.factor(attritionclean$RelationshipSatisfaction)
attritionclean$StockOptionLevel <- as.factor(attritionclean$StockOptionLevel)
attritionclean$WorkLifeBalance <- as.factor(attritionclean$WorkLifeBalance)


str((attritionclean))
```


## Removing non-value added variables from the data set:

Justification for dropping the following variables:

1. EmployeeCount: Always 1, since the data set is by employee
2. Over18: All employees are above 18. Since we have Age, this variable is more useful
3. StandardHours: All are Yes

```{r echo=TRUE, results='asis'}

nonvalueaddedvariabes <- c("EmployeeCount","Over18","StandardHours")
attrition <- attritionclean[ , !(names(attritionclean) %in% nonvalueaddedvariabes)]
knitr::kable(head(attrition))
str(attrition)

## Export to CSV

##write.csv(attrition,file="attrition.csv")

```

## Creating a Training and Testing data set from sampling



```{r echo=TRUE, results='asis'}

set.seed(1234)
ind <- sample(2,nrow(attrition),replace=T,prob = c(0.8,0.2))
train <- attrition[ind==1,]
test <- attrition[ind==2,]

```




## Model 1 - Creating a Logistic Regression Model with all variables without any exclusions


```{r echo=TRUE, results='asis'}

model1 <- glm(Attrition ~ Age + BusinessTravel + DailyRate + Department + DistanceFromHome + Education + EducationField + EnvironmentSatisfaction + Gender + HourlyRate + JobInvolvement + JobLevel+ JobRole + JobSatisfaction + MaritalStatus + MonthlyIncome + MonthlyRate + NumCompaniesWorked + OverTime + PercentSalaryHike + PerformanceRating + RelationshipSatisfaction + StockOptionLevel + TotalWorkingYears + TrainingTimesLastYear + WorkLifeBalance + YearsAtCompany + YearsInCurrentRole + YearsSinceLastPromotion + YearsWithCurrManager, data=train,family = 'binomial')

model1$aic

## Prediction

predmodel1 <- predict(model1,train,type='response')
knitr::kable(head(predmodel1))

comparison1 <- cbind(predmodel1,attrition$Attrition,attrition$EmployeeNumber)
knitr::kable(head(comparison1,40))

##Missclassification error - train data

pred1 <- ifelse(predmodel1>0.5,2,1)
tab1 <- table(Predicted = pred1, Actual = train$Attrition)
knitr::kable(head(tab1))


```


## Model 2 - Creating a Logistic Regression Model by removing variables that are not statistically significant

Removing: TotalWorkingYears, PercentSalaryHike, PerformanceRating, MonthlyRate, MonthlyIncome, MaritalStatus, HourlyRate, EducationField, Education,Gender,Department,DailyRate 

```{r echo=TRUE, results='asis'}

model2 <- glm(Attrition ~ Age + BusinessTravel +    DistanceFromHome +   EnvironmentSatisfaction +   JobInvolvement + JobLevel+ JobRole + JobSatisfaction +   NumCompaniesWorked + OverTime +   RelationshipSatisfaction + StockOptionLevel + TrainingTimesLastYear + WorkLifeBalance + YearsAtCompany + YearsInCurrentRole + YearsSinceLastPromotion + YearsWithCurrManager, data=train,family = 'binomial')

model2$aic
model2$rank
##knitr::kable(summary(model2))
## Prediction

predmodel2 <- predict(model2,train,type='response')
knitr::kable(head(predmodel2))

comparison2 <- cbind(predmodel2,attrition$Attrition,attrition$EmployeeNumber)
knitr::kable(head(comparison2,40))

##Missclassification error - train data

pred2 <- ifelse(predmodel2>0.5,2,1)
tab2 <- table(Predicted = pred2, Actual = train$Attrition)
knitr::kable(head(tab2))

##Missclassification percentage
1-sum(diag(tab2))/sum(tab2)


##Missclassification error - testing data

p2t <- predict(model2,test,type = 'response')
pred2t <- ifelse(p2t>0.5,2,1)
tab2t <- table(Predicted = pred2t, Actual=test$Attrition)
knitr::kable(head(tab2t))
1-sum(diag(tab2t))/sum(tab2t)

# Goodness of fit test

with(model2,pchisq(null.deviance-deviance,df.null-df.residual,lower.tail = F))



```


